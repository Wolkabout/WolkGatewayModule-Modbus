# WolkGateway Module Modbus
WolkGateway module for connecting Modbus devices to WolkAbout IoT Platform by communicating with [WolkGateway](https://github.com/Wolkabout/WolkGateway).

Supported protocol(s):
* JSON_PROTOCOL

Installing from source
----------------------

This repository must be cloned from the command line using:
```sh
git clone --recurse-submodules https://github.com/Wolkabout/WolkGatewayModule-Modbus.git
```

Prerequisite
------------
Following tools/libraries are required in order to build WolkGateway Module Modbus

* cmake - version 3.5 or later
* autotools
* automake
* autoconf
* m4
* zlib1g-dev
* libtool
* python
* python pip
* conan

Former can be installed on Debian based system from terminal by invoking:
```sh
sudo apt-get install automake autotools-dev autoconf m4 zlib1g-dev cmake libtool python python-pip && sudo python -m pip install conan
```
Afterwards dependencies are built, and Makefile build system is generated by invoking:
```sh
./configure
```

Generated build system is located inside `out` directory

WolkGateway Module Modbus library, is built from `out` directory by 
invoking `make` in terminal

Note: If you're working in CLion, setup the project by importing the project as existing CMake project,
installing the conan plugin, and setting the CMake generation path in Settings/Build, Execution, Deployment to 'out'

Module Configuration
--------------------
Module configuration consists of 3 configurations files

* Device configuration
* Modbus configuration
* Modbus register mapping

Below are sections describing each of these configuration files that need to be edited with the parameters of your modbus devices before running the application.
These files are located in `out` directory, and are passed to Modbus module executable in following manner:
```sh
./modbusModule deviceConfiguration.json modbusConfiguration.json modbusRegisterMapping.json
```

Device configuration
--------------------
Device configuration file contains settings that relate to communication with WolkGateway Module.

```json5
{
    "name": "DEVICE_NAME",                  // Device name
    "key": "DEVICE_KEY",                    // Device key
    "protocol": "JsonProtocol",             // Protocol used on WolkGateway
    "localMqttUri": "tcp://localhost:1883"  // WolkGateway Bus
}
```

Modbus configuration
--------------------
Modbus configuration file contains setting that relate to Modbus communication protocol settings,
such as slave IP address, port, response timeout etc.

Here one can select between two modes of modbus communication:

* TCP/IP modbus - supports only one device, use additional WolkGateway-ModbusModules for more devices.

```json5
{
    // TCP/IP Configuration
    "ip": "192.168.x.x",          // Slave IP address
    "port": 502,                  // Slave port
```

* Serial RTU - supports communication with multiple slaves

```json5
    // SERIAL/RTU Configuration
    "serialPort": "SERIAL_PORT",    // Serial port
    "baudRate": BAUD_RATE,          // Baud rate
    "dataBits": 8,                  // Number of data bits
    "stopBits": 1,                  // Number of stop bits
    "bitParity": "NONE",            // Bit parity - "NONE" or "EVEN" or "ODD"
    "slaveAddress" : 1              // Initial slave address
```

Select preferred connection type and register read parameters

```json5
    // Modbus connection type configuration
    "connectionType": "SERIAL/RTU", // Connection type - "SERIAL/RTU" or "TCP/IP"

    // Modbus register read parameters
    "responseTimeoutMs": 200,       // Register read/write timeout
    "registerReadPeriodMs": 500     // Register pool period
}
```

Modbus register mapping
-----------------------
Modbus register mapping file contains settings that map modbus registers to WolkAbout IoT Platform sensors/actuators/alarms/configurations.

* Actuators (read & write):
    - `COIL`
    - `HOLDING_REGISTER_ACTUATOR`
* Sensors (read only):
    - `HOLDING_REGISTER_SENSOR`
    - `INPUT_REGISTER`
    - `INPUT_CONTACT`
    
Mappings are by default registered as:
- Sensors for read only types
- Actuator for read & write types

You can override this behaviour by adding a field to the mapping, stating one of the next types:
- `SENSOR`
- `ACTUATOR`
- `ALARM` - only for `INPUT_CONTACT`
- `CONFIGURATION` - only for `COIL` and `HOLDING_REGISTER_ACTUATOR` (can be also multi value)

A mapping that has the register type `HOLDING_REGISTER_ACTUATOR` and is a `CONFIGURATION` can be multi-value.
What that means, is that it can combine multiple registers into a single configuration. That configuration has label
for each of its values, which you assign in the `labelMap`.
*Note that you can have a total maximum of <b>3</b> values inside a multi-value configuration*

```json5
{
   "modbusRegisterMapping":[
      {
         "name":"mappingName",              // Register name
         "reference": "mappingReference",   // Unique reference used to differ register on WolkAbout IoT Platform

         "minimum": -32768,                 // Minimum value that can be held in register. Required for visualization on WolkAbout IoT Platform
         "maximum": 32767,                  // Maximum value that can be held in register. Required for visualization on WolkAbout IoT Platform

         "address": 0,                      // Register address
         "registerType": "INPUT_REGISTER",  // Register type - "INPUT_REGISTER" or "HOLDING_REGISTER_ACTUATOR" or "HOLDING_REGISTER_SENSOR" or "INPUT_CONTACT" or "COIL"
         "dataType": "INT16",               // Data type stored in register - "INT16" or "UINT16" or "REAL32" for "INPUT_REGISTER"/"HOLDING_REGISTER_ACTUATOR"/"HOLDING_REGISTER_SENSOR" register type, and "BOOL" for "COIL"/"INPUT_CONTACT"
         "slaveAddress": 1                  // Slave address where the register is located - Ignored for TCP/IP (by default set to 1)
      },
      {
         "name":"mappingName2",
         "reference": "mappingReference2",

         "minimum": -4000,
         "maximum": 4000,

         "address": 1,
         "registerType": "HOLDING_REGISTER_ACTUATOR",
         "dataType": "REAL32",
         "slaveAddress" : 1
      },
      {
         "name": "mappingName3",
         "reference": "mappingReference3",

         "address": 1,
         "registerType": "INPUT_CONTACT",
         "dataType": "BOOL",
         "mappingType": "ALARM",             // This is where for the first time, we override the default Mapping type
         "slaveAddress" : 1
      },
      {
         "name":"mappingName4",
         "reference": "mappingReference4",

         "address": 2,
         "registerType": "COIL",
         "dataType": "BOOL",
         "mappingType": "CONFIGURATION",
         "slaveAddress" : 2
      },
      {
         "name": "mappingName5",
         "reference": "mappingReference5",

         "minimum": 0,
         "maximum": 1000,

         "labelMap": {                       // If you want to use a multi-value numeric configuration
            "firstConfig": 0,                // You can use the label map, to name the labels inside the configuration
            "secondConfig": 1,               // And assign a register address to each of them
            "thirdConfig": 2                 // Multi-value is only available for HOLDING_REGISTER_ACTUATOR 
         },
         "registerType": "HOLDING_REGISTER_ACTUATOR",
         "dataType": "INT16",
         "mappingType": "CONFIGURATION",
         "slaveAddress": 2
      },
      {
         "name":"mappingName6",
         "reference": "mappingReference6",

         "address": 3,
         "registerType": "COIL",
         "dataType": "BOOL",
         "slaveAddress" : 2
      }
   ]
}
```
